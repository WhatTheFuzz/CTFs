# Filtered-Shellcode

## Introduction

> A program that just runs the code you give it? That seems kinda boring.

The author of the program is MADSTACKS for picoCTF. We are given the following:

`fun` - i386 32-bit executable.
`nc mercury.picoctf.net 28494` - The address and port of the remote server.

## Information Gathering

### Hint #1

> Take a look at the calling convention and see how you might be able to setup all the registers.

We know that i386 has a calling convention that passes input to functions via the stack. I think what this hint is referring to is that when we call a syscall, we first need to setup the registers to pass the input. Assuming our goal is to pop a shell and then cat the flag, our registers should look like this:

```txt
$eax: syscall NR        /* sycall for execve -> 0x36 (59d) */
$ebx: first argument    /* *filename         -> /bin/sh */
$ecx: second argument   /* *argv[]           -> 0       */
$edx: third argument    /* *envp[]           -> junk    */
```

### Static

We decompiled the program with Ghidra. The program takes up to 1000 bytes, transforms them in some manner, and then executes the code inside the function `execute`. It appears to place two `nop` instructions (`\x90`) between every two bytes of input we give it. It looks like a pain to reverse so let's see if some dynamic analysis can help us.

### Dynamic

Examining the program with GDB (br \* 0x080486a3 and br \* 0x080485c9), the following input got transformed as such:

"abcdefghijklmnopqrstuvwxyz" -> "ab\x90\x90cd\x90\x90ef\x90\x90gh\x90\x90ij\x90\x90kl\x90\x90mn\x90\x90op\x90\x90qr\x90\x90st\x90\x90uv\x90\x90wx\x90\x90yz"

The latter bytes are the ones that we will be directly executing. If this transform pattern holds for all 1000 bytes that we can input it means that we'll be limited to two character opcodes. Before making life complicated, let's test this out with the function `test_pattern` inside our solution. The Python GDB API is awesome and really poorly documented at the same time. Using the API probably took longer to figure out than creating the shellcode did.

## Strategy

Alright, so we need to create shellcode that only occupies two bytes at a time. Can't say we've done this before.
